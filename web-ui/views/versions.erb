<div class="versions_div">
  <% counter = 0 %>
  <% [Uhuru::BoshCommander::Versioning::Product::TYPE_UCC, Uhuru::BoshCommander::Versioning::Product::TYPE_STEMCELL, Uhuru::BoshCommander::Versioning::Product::TYPE_SOFTWARE].each do |type| %>
      <% products.each do |product| %>
          <% if product[1].type == type %>

              <span class="table_title"><%= product[1].label %></span>

              <table class="versions_table">
                <thead>
                <tr class="settings_table_header">
                  <td class="td_versions">Version</td>
                  <td class="td_descriptions">Description</td>
                  <td class="td_state">State</td>
                  <td class="td_size">Size</td>
                  <td class="td_deployments">Deployments</td>
                  <td class="td_dependencies">Dependencies</td>
                  <td class="td_actions">Actions</td>
                </tr>
                </thead>

                <tbody>
                <% product[1].versions.each do |version| %>
                    <tr>
                      <!-- VERSION -->
                      <td class="td_versions">
                        <%= version[1].version %>
                      </td>

                      <!-- DESCRIPTION -->
                      <td class="td_descriptions">
                        <%= version[1].description %>
                      </td>

                      <% Uhuru::BoshCommander::CommanderBoshRunner.execute(session) do %>

                          <!-- STATE -->
                          <td class="td_state states <%= version[1].get_state.to_s %>">
                            <div class="<%= product[1].name.to_s %>" id="<%= version[1].version.to_s %>">
                                <% if version[1].get_state.to_s == '1' %>
                                    <div class="remote_only">Remote Only</div>
                                <% elsif version[1].get_state.to_s == '2' %>
                                    <div class="downloading">Downloading</div>
                                <% elsif version[1].get_state.to_s == '3' %>
                                    <div class="local">Local</div>
                                <% elsif version[1].get_state.to_s == '4' %>
                                    <div class="local_preparing">Local Preparing</div>
                                <% elsif version[1].get_state.to_s == '5' %>
                                    <div class="available">Available</div>
                                <% elsif version[1].get_state.to_s == '6' %>
                                    <div class="deployed">Deployed</div>
                                <% else %>
                                    <div class="selected_state error">Error</div>
                                <% end %>
                            </div>
                          </td>

                          <!-- SIZE -->
                          <td class="td_size">
                            <%= version[1].location.size %>
                          </td>

                          <!-- DEPLOYMENTS -->
                          <td class="td_deployments">
                            <%= version[1].deployments %>
                          </td>

                          <!-- DEPENDENCIES -->
                          <td class="td_dependencies">
                            <% [Uhuru::BoshCommander::Versioning::Product::TYPE_UCC, Uhuru::BoshCommander::Versioning::Product::TYPE_STEMCELL, Uhuru::BoshCommander::Versioning::Product::TYPE_SOFTWARE].each do |type| %>
                                <% if product[1].type == type %>
                                    <% version[1].dependencies.each do |dependency| %>
                                        <%= dependency['dependency'] %>
                                        (
                                        <% if dependency['version'].count != nil %>
                                            <% dependency['version'].each_with_index do |version, index| %>
                                                <% if index < dependency['version'].length - 1 %>
                                                    <%= version + ', ' %>
                                                <% else %>
                                                    <%= version %>
                                                <% end %>
                                            <% end %>
                                        <% end %>
                                        )
                                        <br />
                                    <% end %>
                                <% end %>
                            <% end %>
                          </td>

                          <!-- ACTION -->
                          <td class="td_actions">
                            <% if version[1].get_state.to_s == '5' %>
                                <form method="post" action="">
                                  <input type="hidden" value="<%= product[1].name.to_s %>" name="product" />
                                  <input type="hidden" value="<%= version[1].version.to_s %>" name="version" />
                                    <input type="submit" value="" class="action_buttons delete" title="Delete <%= product[1].label %>&nbsp;<%= version[1].version.downcase %>" />
                                </form>
                            <% end %>

                            <% if version[1].get_state.to_s != '1' %>
                                <input
                                    type="button"
                                    value=""
                                    id="downloadbtn_<%= counter %>"
                                    class="action_buttons download"
                                    onclick="download_and_state('<%= product[1].name.to_s %>', '<%= version[1].version.to_s %>', 'progressbar_<%= counter %>', 'downloadbtn_<%= counter %>');"
                                    title="Download <%= product[1].label %>&nbsp;<%= version[1].version %>"
                                />
                                <progress id="progressbar_<%= counter %>" value="0" max="100" style="width: 50px; display: none;" />
                                <% counter += 1 %>
                            <% end %>
                          </td>
                      <% end %>

                    </tr>
                <% end %>
                </tbody>
              </table>
          <% end %>
      <% end %>
  <% end %>
</div>


<script type="text/javascript">
    function download_and_state(product, version, progressbar_id, button_id)
    {
        var is_loaded = false;
        var current_cell = null;
        $.get('download', { product: product, version: version });

        $('.states div:first-child').each(function(item, object)
        {
            if (object.classList[0] == product && object.id == version)
            {
                current_cell = object;
                object.innerHTML = "<div class='downloading'>Downloading</div>";
                $('#' + progressbar_id).show();
                $('#' + button_id).hide();
            }
        });

        var process = setInterval(
                function(){
                    $.get('download_state',
                            { product: product, version: version },
                            function(data)
                            {
                                $('#' + progressbar_id).attr('value', parseInt(data));
                                if(data == 100)
                                {
                                    $.get('refresh_state', { product: product, version: version }, function(response){
                                        if(response == '1')
                                        {
                                            current_cell.innerHTML = "<div class='remote_only'>Remote Only</div>";
                                            $('#' + button_id).show();
                                            $('#' + progressbar_id).hide();
                                        }
                                        if(response == '2')
                                        {
                                            current_cell.innerHTML = "<div class='downloading'>Downloading</div>";
                                            $('#' + button_id).show();
                                            $('#' + progressbar_id).hide();
                                        }
                                        if(response == '3')
                                        {
                                            current_cell.innerHTML = "<div class='local'>Local</div>";
                                            $('#' + button_id).show();
                                            $('#' + progressbar_id).hide();
                                        }
                                        if(response == '4')
                                        {
                                            current_cell.innerHTML = "<div class='local_preparing'>Local Preparing</div>";
                                            $('#' + button_id).show();
                                            $('#' + progressbar_id).hide();
                                        }
                                        if(response == '5')
                                        {
                                            current_cell.innerHTML = "<div class='available'>Available</div>";
                                            $('#' + button_id).show();
                                            $('#' + progressbar_id).hide();
                                        }
                                        if(response == '6')
                                        {
                                            current_cell.innerHTML = "<div class='deployed'>Deployed</div>";
                                            $('#' + button_id).show();
                                            $('#' + progressbar_id).hide();
                                        }
                                        if(response == '')
                                        {
                                            current_cell.innerHTML = "<div class='error'>Error</div>";
                                            $('#' + button_id).show();
                                            $('#' + progressbar_id).hide();
                                        }
                                    });
                                    clearInterval(process);
                                }
                            }
                    );
                }, 1000
        );
    }
</script>


