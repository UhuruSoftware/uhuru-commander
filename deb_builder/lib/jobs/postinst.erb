#!/bin/bash

BOSH_INSTALL_TARGET=/var/vcap/data/jobs/<%= job_name %>
cd /<%= target_bits_dir %>

mkdir -p ${BOSH_INSTALL_TARGET}/uhuru_templates

cp -Rf /<%= target_bits_dir %>/* ${BOSH_INSTALL_TARGET}/uhuru_templates/
/var/vcap/packages/ruby/bin/ruby generate_templates.rb "/<%= target_bits_dir %>" "${BOSH_INSTALL_TARGET}"

mkdir -p /etc/monit/uhururc.d
mkdir -p /etc/monit/uhururc.d_pieces

cp monit /etc/monit/uhururc.d_pieces/<%= job_name %>

find /etc/monit/uhururc.d_pieces/ -type f -exec cat {} \; -exec echo -e "\n  mode manual\n\n" \; > /etc/monit/uhururc.d/jobs

mkdir -p /var/vcap/jobs/
rm -f /var/vcap/jobs/<%= job_name %>
ln -s ${BOSH_INSTALL_TARGET} /var/vcap/jobs/<%= job_name %>

cd /

rm -rf /<%= target_bits_dir %>

echo "Reconfiguring monit ..."

echo "START=1" > /etc/default/monit


MONIT_PASSWORD=`tr -cd '[:alnum:]' < /dev/urandom | fold -w16 | head -n1`
echo "vcap:${MONIT_PASSWORD}" > /etc/monit/monit.user

echo "set daemon 10

set logfile /var/log/monit.log

set httpd port 2822 and use address 127.0.0.1
    allow cleartext /etc/monit/monit.user

set eventqueue
    basedir /var/lib/monit/events # set the base directory where events will be stored
    slots 5000                     # optionally limit the queue size

include /etc/monit/uhururc.d/*

" > /etc/monit/monitrc

chmod 600 /etc/monit/monitrc

echo "Restarting monit ..."

service monit restart

exit 0
